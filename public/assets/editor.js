dc.ui.EditorToolbar=Backbone.View.extend({className:"editor_toolbar interface",constructor:function(){Backbone.View.apply(this,arguments);this.modes={};this.viewer=currentDocument;this.imageUrl=this.viewer.schema.document.resources.page.image},toggle:function(){"is"==this.modes.open?(this.close(),this.showSelectedThumbnail()):(dc.app.editor.closeAllEditors(),this.open())},showSelectedThumbnail:function(){$(".DV-thumbnail.DV-originallySelected").removeClass("DV-originallySelected").addClass("DV-selected")},
hideSelectedThumbnail:function(){$(".DV-thumbnail.DV-selected").removeClass("DV-selected").addClass("DV-originallySelected")}});
dc.ui.AnnotationEditor=Backbone.View.extend({id:"annotation_editor",events:{"click .close":"close"},initialize:function(a){this._open=!1;this._buttons={};this._baseURL="/documents/"+dc.app.editor.docId+"/annotations";this._inserts=$(".DV-pageNoteInsert");this.redactions=[];_.bindAll(this,"open","close","drawAnnotation","saveAnnotation","deleteAnnotation","createPageNote");currentDocument.api.onAnnotationSave(this.saveAnnotation);currentDocument.api.onAnnotationDelete(this.deleteAnnotation);this._inserts.click(this.createPageNote)},
open:function(a){this._open=!0;this._buttons[a]=$("#control_panel ."+a+"_annotation");this.pages=$(".DV-pages");this.page=$(".DV-page");this._guide=$("#"+a+"_note_guide");this.redactions=[];this.page.css({cursor:"crosshair"});"redact"!=a&&this._inserts.filter(".visible").show().addClass("DV-"+a);this.page.bind("mousedown",this.drawAnnotation);$(document).bind("keydown",this.close);$(document.body).setMode(a,"editing");this._buttons[a].addClass("open");this._guide.fadeIn("fast")},close:function(){this._open=
!1;this.page.css({cursor:""});this.page.unbind("mousedown",this.drawAnnotation);$(document).unbind("keydown",this.close);this.clearAnnotation();this.clearRedactions();this._inserts.hide().removeClass("DV-public DV-private");$(document.body).setMode(null,"editing");this._buttons[this._kind].removeClass("open");this._guide.hide()},toggle:function(a){if(this._open&&(this.close(),a===this._kind))return;this.open(this._kind=a)},clearAnnotation:function(){this.region&&$(this.region).remove()},clearRedactions:function(){$(".DV-annotationRegion.DV-accessRedact").remove()},
createPageNote:function(a){this.close();a=$(a.target).closest(".DV-set");a=currentDocument.api.getPageNumberForId(a.attr("data-id"));currentDocument.api.addAnnotation({page:a,unsaved:!0,access:this._kind||"public",owns_note:!0})},drawAnnotation:function(a){a.stopPropagation();a.preventDefault();this._activePage=$(a.currentTarget);this._activePageNumber=currentDocument.api.getPageNumberForId($(this._activePage).closest(".DV-set").attr("data-id"));this.clearAnnotation();var b=this._activePage.offset().top,
c=this._activePage.offset().left,d=a.pageX-c,e=a.pageY-b,f=this._activePage.height()-6,g=this._activePage.width()-6;this.region=this.make("div",{"class":"DV-annotationRegion active "+this._accessClass(this._kind),style:"position:absolute;"});("redact"==this._kind?this._specificPage():this._activePage).append(this.region);var k=function(a){var h=a.pageX-c-3;a=a.pageY-b-3;h=0>h?0:h>g?g:h;a=0>a?0:a>f?f:a;return{left:Math.min(d,h),top:Math.min(e,a),width:Math.abs(h-d),height:Math.abs(a-e)}};$(this.region).css(k(a));
var l=_.bind(function(a){$(this.region).css(k(a));return!1},this);this.pages.on("mousemove",l);var m=_.bind(function(a){$(document).unbind("keydown",this.close);this.pages.unbind("mouseup",m).unbind("mousemove",l);a=k(a);a.left-=1;a.top-=1;a.right=a.left+a.width;a.bottom=a.top+a.height;"redact"!=this._kind&&(a.top+=2,a.left+=5,a.right+=15,a.bottom+=5);var b=currentDocument.api.relativeZoom(),c=_.map([a.top,a.right,a.bottom,a.left],function(a){return Math.round(a/b)}).join(",");"redact"==this._kind?
(5<a.width&&5<a.height?this.redactions.push({location:c,page:this._activePageNumber}):$(this.region).remove(),this.region=null):(this.close(),5<a.width&&5<a.height&&currentDocument.api.addAnnotation({location:{image:c},page:this._activePageNumber,unsaved:!0,access:this._kind,owns_note:!0}));return!1},this);this.pages.bind("mouseup",m)},saveAnnotation:function(a){this[a.unsaved?"createAnnotation":"updateAnnotation"](a)},annotationToParams:function(a,b){delete a.unsaved;var c={page_number:a.page,content:a.text,
title:a.title,access:a.access};a.location&&(c.location=a.location.image);return _.extend(c,b||{})},createAnnotation:function(a){var b=this.annotationToParams(a);$.ajax({url:this._baseURL,type:"POST",data:b,dataType:"json",success:_.bind(function(b){a.server_id=b.id;this._adjustNoteCount(1,"public"==this._kind?1:0)},this)})},updateAnnotation:function(a){var b=this._baseURL+"/"+a.server_id;a=this.annotationToParams(a,{_method:"put"});$.ajax({url:b,type:"POST",data:a,dataType:"json"})},deleteAnnotation:function(a){a.server_id&&
$.ajax({url:this._baseURL+"/"+a.server_id,type:"POST",data:{_method:"delete"},dataType:"json",success:_.bind(function(){this._adjustNoteCount(-1,"public"==this._kind||"public"==a.access?-1:0)},this)})},_specificPage:function(){var a=$(".DV-pageSpecific-"+this._activePageNumber);if(a.length)return a;a=this.make("div",{"class":"DV-pageSpecific DV-pageSpecific-"+this._activePageNumber});this._activePage.append(a);return $(a)},_adjustNoteCount:function(a,b){try{var c=parseInt(currentDocument.api.getId(),
10),d=window.opener.Documents.get(c);d&&(d.set({annotation_count:(d.get("annotation_count")||0)+a}),d.set({public_note_count:(d.get("public_note_count")||0)+b}))}catch(e){}},_accessClass:function(a){return"DV-access"+dc.inflector.capitalize(a)}});
dc.ui.ViewerControlPanel=Backbone.View.extend({id:"control_panel",events:{"click .set_sections":"openSectionEditor","click .public_annotation":"togglePublicAnnotation","click .private_annotation":"togglePrivateAnnotation","click .redact_annotation":"toggleRedaction","click .cancel_redactions":"toggleRedaction","click .save_redactions":"saveRedactions","click a.when_black":"toggleRedactionColor","click a.when_red":"toggleRedactionColor","click .edit_document_info":"editDocumentInfo","click .edit_description":"editDescription",
"click .edit_title":"editTitle","click .edit_source":"editSource","click .edit_access":"editAccess","click .edit_related_article":"editRelatedArticle","click .edit_document_url":"editPublishedUrl","click .edit_data":"editData","click .edit_remove_pages":"editRemovePages","click .edit_reorder_pages":"editReorderPages","click .edit_page_text":"editPageText","click .reprocess_text":"reprocessText","click .edit_replace_pages":"editReplacePages","click .toggle_document_info":"toggleDocumentInfo","click .embed_document":"embedDocument",
"click .embed_note":"embedNote","click .access_info":"editAccess"},initialize:function(){var a=this._getDocumentModel();_.bindAll(this,"closeDocumentOnAccessChange","onDocumentChange","render");a.bind("change:access",this.render);a.bind("change",this.onDocumentChange);this.redactionColor="black"},render:function(){var a=dc.model.Account.prototype,a=dc.account.get("role")==a.ADMINISTRATOR||dc.account.get("role")==a.CONTRIBUTOR||dc.account.get("role")==a.FREELANCER;this.viewer=currentDocument;this._page=
this.viewer.$(".DV-textContents");var b=this._getDocumentModel().get("access");$(this.el).html(JST.control_panel({isReviewer:dc.app.editor.options.isReviewer,isOwner:dc.app.editor.options.isOwner,workspacePrefix:a?"#":"",docAccess:b,orgName:this.viewer.api.getContributorOrganization()}));this.showReviewerWelcome();return this},showReviewerWelcome:function(){var a=dc.app.editor.options.reviewerInviter;if(dc.account.get("role")==dc.model.Account.prototype.REVIEWER&&a){var b=_.t("x_invited_to_review_x",
a.fullName,dc.inflector.truncate(currentDocument.api.getTitle(),50)),a=JST.reviewer_welcome(a),b=dc.ui.Dialog.alert("",{description:a,title:b});$(b.el).addClass("wide_dialog");b.center()}},openSectionEditor:function(){dc.app.editor.sectionEditor.open()},prompt:function(a,b,c,d){dc.ui.Dialog.prompt(a,b,function(a,d){return b!=a?c(a,d):!0},d)},editDocumentInfo:function(a){$(a.target).is(".toggle_document_info")||(a=this._getDocumentModel(),new dc.ui.DocumentDialog([a]))},editTitle:function(){this.prompt(_.t("title"),
this.viewer.api.getTitle(),_.bind(function(a){this.viewer.api.setTitle(a);this._updateDocument({title:a});return!0},this),{mode:"short_prompt"})},editSource:function(){this.prompt(_.t("source"),this.viewer.api.getSource(),_.bind(function(a){this.viewer.api.setSource(a);this._updateDocument({source:a});return!0},this),{mode:"short_prompt"})},editRelatedArticle:function(){this.prompt(_.t("related_article_url"),this.viewer.api.getRelatedArticle(),_.bind(function(a,b){if((a=dc.inflector.normalizeUrl(a))&&
!b.validateUrl(a))return!1;this.viewer.api.setRelatedArticle(a);this._updateDocument({related_article:a});return!0},this),{mode:"short_prompt",description:_.t("related_url_of_document")})},editPublishedUrl:function(){this.prompt(_.t("published_url"),this.viewer.api.getPublishedUrl(),_.bind(function(a,b){if((a=dc.inflector.normalizeUrl(a))&&!b.validateUrl(a))return!1;this.viewer.api.setPublishedUrl(a);this._updateDocument({remote_url:a});return!0},this),{mode:"short_prompt",description:_.t("embed_url_of_document")})},
editDescription:function(){this.prompt(_.t("description"),this.viewer.api.getDescription(),_.bind(function(a){this.viewer.api.setDescription(a);this._updateDocument({description:a});return!0},this))},editAccess:function(){Documents.editAccess([this.docModel],this.closeDocumentOnAccessChange)},editData:function(){new dc.ui.DocumentDataDialog([this.docModel])},closeDocumentOnAccessChange:function(){if(this.docModel.hasChanged("access")){this.setOnParent(this.docModel,{access:dc.access.PENDING});var a=
_.t("access_level_edit_closing");dc.ui.Dialog.alert(a,{onClose:function(){window.close()}})}},onDocumentChange:function(a){this.viewer.api.setTitle(a.get("title"));this.viewer.api.setSource(a.get("source"));this.viewer.api.setRelatedArticle(a.get("related_article"));this.viewer.api.setPublishedUrl(a.get("remote_url"));this.viewer.api.setDescription(a.get("description"));this.setOnParent(a,{title:a.get("title"),source:a.get("source"),related_article:a.get("related_article"),remote_url:a.get("remote_url"),
description:a.get("description"),access:a.get("access"),data:_.clone(a.get("data"))});a.hasChanged("access")&&this.closeDocumentOnAccessChange()},reprocessText:function(){var a=this,b=_.t("close_while_text_reprocess"),c=new dc.ui.Dialog.confirm(_.t("text_reprocess_help"),function(){var d=a._getDocumentModel();d.reprocessText();a.setOnParent(d,{access:dc.access.PENDING});$(c.el).remove();_.defer(dc.ui.Dialog.alert,b,{onClose:function(){window.close()}})},{width:450}),d=$(c.make("span",{"class":"force_ocr minibutton dark center_button"},
_.t("force_ocr"))).bind("click",function(){var d=a._getDocumentModel();d.reprocessText(!0);a.setOnParent(d,{access:dc.access.PENDING});$(c.el).remove();_.defer(dc.ui.Dialog.alert,b,{onClose:function(){window.close()}})});c.$(".ok").addClass("reprocess").text(_.t("reprocess")).before(d)},openTextTab:function(){"ViewText"!=this.viewer.state&&this.viewer.open("ViewText")},openThumbnailsTab:function(){"ViewThumbnails"!=this.viewer.state&&this.viewer.open("ViewThumbnails")},openDocumentTab:function(){"ViewDocument"!=
this.viewer.state&&this.viewer.open("ViewDocument")},editPageText:function(){this.openTextTab();dc.app.editor.editPageTextEditor.toggle()},editReplacePages:function(){this.openThumbnailsTab();dc.app.editor.replacePagesEditor.toggle()},editRemovePages:function(){this.openThumbnailsTab();dc.app.editor.removePagesEditor.toggle()},editReorderPages:function(){this.openThumbnailsTab();dc.app.editor.reorderPagesEditor.toggle()},togglePublicAnnotation:function(){this.openDocumentTab();dc.app.editor.annotationEditor.toggle("public")},
togglePrivateAnnotation:function(){this.openDocumentTab();dc.app.editor.annotationEditor.toggle("private")},toggleRedaction:function(){this.openDocumentTab();dc.app.editor.annotationEditor.toggle("redact")},toggleRedactionColor:function(){var a=this.viewer.elements.viewer;this.redactionColor="black"==this.redactionColor?"red":"black";$(a).toggleClass("DV-redRedactions","red"==this.redactionColor)},toggleDocumentInfo:function(){var a=$(".edit_document_fields").is(":visible");$(".document_fields_container").setMode(a?
"hide":"show","document_fields");$(".document_fields_container .toggle").setMode(a?"not":"is","enabled")},embedDocument:function(){var a=this._getDocumentModel();(new dc.ui.DocumentEmbedDialog(a)).render()},embedNote:function(){var a=this._getDocumentModel();Documents.reset([a]);dc.app.noteEmbedDialog=new dc.ui.NoteEmbedDialog(a)},saveRedactions:function(){var a=this.viewer.api.getModelId(),b=dc.app.editor.annotationEditor.redactions;if(!b.length)return dc.app.editor.annotationEditor.close();var c=
_.t("redaction_close_while_processing");dc.ui.Dialog.confirm(c,_.bind(function(){$.ajax({url:"/documents/"+a+"/redact_pages",type:"POST",data:{redactions:JSON.stringify(b),color:this.redactionColor},dataType:"json",success:_.bind(function(b){this.setOnParent(a,b);window.close();_.defer(dc.ui.Dialog.alert,_.t("close_while_redacting"))},this)});return!0},this))},setOnParent:function(a,b){try{(a=window.opener&&window.opener.Documents&&window.opener.Documents.get(a))&&a.set(b)}catch(c){}},_getDocumentModel:function(){if(this.docModel)return this.docModel;
this.docModel=new dc.model.Document(window.currentDocumentModel);this.docModel.viewerEditable=dc.account.get("isOwner");this.docModel.suppressNotifier=!0;return this.docModel},_updateDocument:function(a){var b=this._getDocumentModel();b.save(a);this.setOnParent(b,a)}});
dc.ui.EditPageTextEditor=dc.ui.EditorToolbar.extend({id:"edit_page_text_container",events:{"click .edit_page_text_confirm_input":"confirmEditPageText","click .document_page_tile_remove":"resetPage","click .close_editor":"close"},initialize:function(a){this.editor=a.editor;_.bindAll(this,"cachePageText")},_resetState:function(){this.originalPageText={};this.pageText={}},findSelectors:function(){this.$s={guide:$("#edit_page_text_guide"),guideButton:$(".edit_page_text.button"),page:$(".DV-text"),pages:$(".DV-pages"),
viewerContainer:$(".DV-docViewer-Container"),header:$("#edit_page_text_container"),container:null,saveButton:$(".edit_page_text_confirm_input",this.el),headerTiles:$(".document_page_tiles",this.el)}},open:function(){$(this.el).show();this.findSelectors();this._resetState();this.setMode("is","open");this.viewer.api.enterEditPageTextMode();this.render()},render:function(){$(this.el).html(JST.edit_page_text({}));this.$s.viewerContainer.append(this.el);"ViewText"!=this.viewer.state&&this.viewer.open("ViewText");
this.$s.pages.addClass("edit_page_text_viewer");this.$s.container=$(this.el);this.findSelectors();this.$s.guideButton.addClass("open");this.$s.guide.fadeIn("fast");this.$s.saveButton.setMode("not","enabled");this.$s.header.removeClass("active");this.handleEvents()},handleEvents:function(){$(".DV-textContents").parent().delegate(".DV-textContents","keyup",this.cachePageText).delegate(".DV-textContents","change",this.cachePageText)},getPageNumber:function(){return this.viewer.api.currentPage()},getPageText:function(a){a=
a||this.getPageNumber();return this.viewer.api.getPageText(a)},confirmEditPageText:function(){var a=this.getChangedPageTextPages(),b=this.viewer.api.getModelId(),c=dc.ui.Dialog.progress("Saving text edits&hellip;");$.ajax({url:"/documents/"+b+"/save_page_text",type:"POST",data:{modified_pages:JSON.stringify(a)},dataType:"json",success:_.bind(function(a){try{window.opener&&window.opener.Documents&&window.opener.Documents.get(b).set(a)}catch(e){}window.close();c.close();this.viewer.api.resetPageText(!0);
_.defer(dc.ui.Dialog.alert,"The page text is being saved. Please close this document.")},this)})},setSaveState:function(){this.editor.setSaveState(!!_.keys(this.pageText).length)},cachePageText:function(){var a=this.getPageNumber(),b=dc.inflector.trim($(".DV-textContents").textWithNewlines());a in this.originalPageText||(this.originalPageText[a]=$.trim(this.getPageText(a)));b!=this.originalPageText[a]?(a in this.pageText||this.redrawHeader(),this.pageText[a]=b):(delete this.originalPageText[a],delete this.pageText[a],
this.redrawHeader());this.setSaveState();this.viewer.api.setPageText(b,a)},resetPage:function(a){a=$(a.currentTarget).parents(".document_page_tile").attr("data-pageNumber");this.viewer.api.setPageText(this.originalPageText[a],a);this.viewer.api.enterEditPageTextMode();delete this.originalPageText[a];delete this.pageText[a];this.setSaveState();this.redrawHeader()},redrawHeader:function(){var a;a=_.keys(this.originalPageText);var b=a.length;a=a.sort(function(a,b){return a-b});$(".document_page_tile",
this.$s.headerTiles).empty().remove();0==b?(this.$s.header.removeClass("active"),this.$s.saveButton.setMode("not","enabled")):(this.$s.header.addClass("active"),this.$s.saveButton.setMode("is","enabled"));_.each(a,_.bind(function(a){var b=this.imageUrl,b=b.replace(/\{size\}/,"thumbnail"),b=b.replace(/\{page\}/,a),b=$(JST.document_page_tile({url:b,pageNumber:a}));b.attr("data-pageNumber",a);this.$s.headerTiles.append(b)},this));a=0==b?"Save page text":"Save "+b+dc.inflector.pluralize(" page",b);$(".edit_page_text_confirm_input",
this.el).val(a);a=$(".document_page_tile").length*$(".document_page_tile").eq(0).outerWidth(!0);b=$(".editor_toolbar_controls",this.el).outerWidth(!0);this.$s.headerTiles.width(a+b+10);Backbone.View.prototype.delegateEvents.call(this)},getChangedPageTextPages:function(){var a={};_.each(this.pageText,_.bind(function(b,c){this.originalPageText[c]!=b&&(a[c]=b)},this));return a},close:function(){"is"==this.modes.open&&(this._resetState(),this.setSaveState(),this.setMode("not","open"),this.$s.guideButton.removeClass("open"),
this.$s.guide.hide(),this.$s.pages.removeClass("edit_page_text_viewer"),$(".DV-textContents").attr("contentEditable",!1).removeClass("DV-editing"),$(this.el).hide(),this.viewer.api.leaveEditPageTextMode())}});
dc.ui.RemovePagesEditor=dc.ui.EditorToolbar.extend({id:"remove_pages_container",events:{"click .document_page_tile_remove":"removePageFromRemoveSet","click .remove_pages_confirm_input":"confirmRemovePages","click .close_editor":"close"},initialize:function(a){this.editor=a.editor},findSelectors:function(){this.$s={guide:$("#edit_remove_pages_guide"),guideButton:$(".edit_remove_pages"),thumbnails:$(".DV-thumbnail"),thumbnailsContainer:$(".DV-thumbnails"),pages:$(".DV-pages"),viewerContainer:$(".DV-docViewer-Container"),
saveButton:this.$(".remove_pages_confirm_input"),holder:null,container:null}},open:function(){$(this.el).show();this.findSelectors();this.removePages=[];this.setMode("is","open");this.$s.guide.fadeIn("fast");this.$s.guideButton.addClass("open");this.viewer.api.enterRemovePagesMode();this.hideSelectedThumbnail();this.render()},render:function(){$(this.el).show().html(JST.remove_pages({}));this.$s.viewerContainer.append(this.el);"ViewDocument"!=this.viewer.state&&"ViewThumbnails"!=this.viewer.state&&
this.viewer.open("ViewThumbnails");this.$s.pages.addClass("remove_pages_viewer");this.$s.thumbnails.removeClass("DV-selected");this.$s.holder=$(".remove_pages_page_container",this.el);this.$s.container=$(this.el);this.$s.saveButton.setMode("not","enabled");this.redrawPages();this.handleEvents()},unbindEvents:function(){this.$s.thumbnailsContainer.unbind("mousedown.dv-remove")},handleEvents:function(){this.unbindEvents();this.$s.thumbnailsContainer.bind("mousedown.dv-remove",_.bind(function(a){a=$(a.target);
0!=a.closest(".DV-thumbnail-page").length&&(a=a.closest(".DV-thumbnail"),$(".DV-pageImage,.DV-thumbnail-image img",a).eq(0).attr("src"),a=a.attr("data-pageNumber"),_.contains(this.removePages,a)?this.removePageNumberFromRemoveSet(a):this.addPageToRemoveSet(a))},this))},addPageToRemoveSet:function(a){_.contains(this.removePages,a)||(this.viewer.api.addPageToRemovedPages(a),this.removePages.push(a),this.redrawPages(),this.$s.thumbnails.eq(a-1).addClass("DV-selected"))},removePageFromRemoveSet:function(a){a=
$(a.target).parents(".document_page_tile").attr("data-pageNumber");this.removePageNumberFromRemoveSet(a)},removePageNumberFromRemoveSet:function(a){this.removePages=_.reject(this.removePages,function(b){return b==a});this.redrawPages();this.viewer.api.removePageFromRemovedPages(a);this.$s.thumbnails.eq(a-1).removeClass("DV-selected")},redrawPages:function(){var a=this.removePages.length;this.editor.setSaveState(!!a);this.removePages=this.removePages.sort(function(a,b){return a-b});$(".document_page_tile",
this.$s.holder).empty().remove();0==a?(this.$s.container.addClass("empty"),this.$(".remove_pages_confirm_input").setMode("not","enabled")):(this.$s.container.removeClass("empty"),this.$(".remove_pages_confirm_input").setMode("is","enabled"));_.each(this.removePages,_.bind(function(a){var b=this.imageUrl,b=b.replace(/\{size\}/,"thumbnail"),b=b.replace(/\{page\}/,a),b=$(JST.document_page_tile({url:b,pageNumber:a}));b.attr("data-pageNumber",a);this.$s.holder.append(b)},this));this.$(".remove_pages_confirm_input").text(_.t("remove_pages_input",
a));var a=$(".document_page_tile").length*$(".document_page_tile").eq(0).outerWidth(!0),b=$(".editor_toolbar_controls",this.el).outerWidth(!0);this.$s.holder.width(a+b+10)},confirmRemovePages:function(){var a=this.removePages.length;a&&(a>=this.viewer.api.numberOfPages()?dc.ui.Dialog.alert(_.t("cannot_remove_all")):dc.ui.Dialog.confirm(_.t("remove_page_warning_message",a),_.bind(function(){this.$s.saveButton.text(_.t("removing")).attr("disabled",!0).setMode("not","enabled");this.save();return!0},
this)))},save:function(){dc.ui.Dialog.progress("Removing Pages&hellip;");var a=this.viewer.api.getModelId();$.ajax({url:"/documents/"+a+"/remove_pages",type:"POST",data:{pages:this.removePages},dataType:"json",success:function(b){try{window.opener&&window.opener.Documents&&window.opener.Documents.get(a).set(b)}catch(c){}window.close();_.defer(dc.ui.Dialog.alert,_.t("pages_are_being_removed"))}})},close:function(){"is"==this.modes.open&&(this.editor.setSaveState(),this.setMode("not","open"),this.$s.guide.hide(),
this.$s.guideButton.removeClass("open"),this.$s.pages.removeClass("remove_pages_viewer"),this.$s.thumbnails.removeClass("DV-selected"),this.unbindEvents(),$(this.el).empty().hide(),this.viewer.api.leaveRemovePagesMode())}});
dc.ui.ReorderPagesEditor=dc.ui.EditorToolbar.extend({id:"reorder_pages_container",events:{"click .reorder_pages_confirm_input":"confirmReorderPages","click .close_editor":"close"},initialize:function(a){this.editor=a.editor},findSelectors:function(){this.$s={guide:$("#edit_reorder_pages_guide"),guideButton:$(".edit_reorder_pages"),page:$(".DV-page,.DV-thumbnail"),thumbnails:$(".DV-thumbnails"),pages:$(".DV-pages"),viewerContainer:$(".DV-docViewer-Container"),header:$("#reorder_pages_container"),container:null,
saveButton:$(".reorder_pages_confirm_input")}},open:function(){$(this.el).show();this.findSelectors();this.setMode("is","open");this.viewer.api.enterReorderPagesMode();this.viewer.api.resetReorderedPages();this.render();this.orderChanged=!1;this.$s.guide.fadeIn("fast");this.$s.guideButton.addClass("open");this.$s.saveButton.setMode("not","enabled");this.hideSelectedThumbnail()},render:function(){$(this.el).html(JST.reorder_pages({}));this.$s.viewerContainer.append(this.el);this.findSelectors();"ViewThumbnails"!=
this.viewer.state&&this.viewer.open("ViewThumbnails");this.$s.pages.addClass("reorder_pages_viewer");this.$s.container=$(this.el);$(".DV-currentPageImage",this.$s.thumbnails).removeClass("DV-currentPageImage").addClass("DV-currentPageImage-disabled");this.handleEvents();this.initialOrder=this.serializePageOrder()},handleEvents:function(){var a=this.$s.thumbnails;$(".DV-thumbnail",a).each(function(a){$(this).attr("data-pageNumber",a+1)});$(".DV-currentPageImage",a).removeClass("DV-currentPageImage").addClass("DV-currentPageImage-disabled");
jQuery(".DV-thumbnails").sortable({containment:".DV-thumbnails",items:".DV-thumbnail",handle:".DV-thumbnail-page",cursor:"move",scrollSensitivity:80,scrollSpeed:15,tolerance:"pointer",zIndex:10,stop:_.bind(function(a,c){this.refreshHeader()},this)})},refreshHeader:function(){var a=!_.isEqual(this.serializePageOrder(),this.initialOrder);this.orderChanged=a;this.$s.saveButton.setMode(a?"is":"not","enabled");this.editor.setSaveState(a)},confirmReorderPages:function(){this.orderChanged&&dc.ui.Dialog.confirm("You've reordered the pages in this document. The document will close while it's being rebuilt. Are you sure you're ready to proceed?",
_.bind(function(){$("input.reorder_pages_confirm_input",this.el).val("Reordering...").attr("disabled",!0);this.save();return!0},this))},serializePageOrder:function(){var a=[];$(".DV-thumbnail",this.$s.thumbnails).each(function(){a.push(parseInt($(this).attr("data-pageNumber"),10))});return a},save:function(){dc.ui.Dialog.progress("Reordering Pages&hellip;");var a=this.serializePageOrder(),b=this.viewer.api.getModelId();$.ajax({url:"/documents/"+b+"/reorder_pages",type:"POST",data:{page_order:a},dataType:"json",
success:function(a){try{window.opener&&window.opener.Documents&&window.opener.Documents.get(b).set(a)}catch(d){}window.close();_.defer(dc.ui.Dialog.alert,"The pages are being reordered. Please close this document.")}})},close:function(){"is"==this.modes.open&&(this.editor.setSaveState(),$(".DV-currentPageImage-disabled",this.$s.page).addClass("DV-currentPageImage").removeClass("DV-currentPageImage-disabled"),this.setMode("not","open"),jQuery(".DV-thumbnails").sortable("destroy"),this.$s.guide.hide(),
this.$s.guideButton.removeClass("open"),this.$s.pages.removeClass("reorder_pages_viewer"),$(this.el).hide(),this.viewer.api.leaveReorderPagesMode())}});
dc.ui.ReplacePagesEditor=dc.ui.EditorToolbar.extend({id:"replace_pages_container",events:{"click .close_editor":"close"},initialize:function(a){this.editor=a.editor},findSelectors:function(){this.$s={guide:$("#edit_replace_pages_guide"),guideButton:$(".edit_replace_pages"),thumbnails:$(".DV-thumbnail"),thumbnailImages:$(".DV-thumbnail .DV-thumbnail-image"),pages:$(".DV-pages"),viewerContainer:$(".DV-docViewer-Container"),hint:this.$(".editor_hint"),container:null}},open:function(){$(this.el).show();
this.findSelectors();this.setMode("is","open");this.$s.guide.fadeIn("fast");this.$s.guideButton.addClass("open");this.viewer.api.enterReplacePagesMode();this.render();this.hideSelectedThumbnail();this.resetSelected()},resetSelected:function(){$(".DV-currentPageImage",this.$s.pages).removeClass("DV-currentPageImage").addClass("DV-currentPageImage-disabled");this.$s.thumbnails.removeClass("DV-selected");this.$s.thumbnails.find(".left_chosen,.right_chosen").removeClass("left_chosen").removeClass("right_chosen")},
render:function(){"ViewThumbnails"!=this.viewer.state&&this.viewer.open("ViewThumbnails");$(this.el).html(JST.replace_pages({}));this.$s.viewerContainer.append(this.el);this.$s.pages.addClass("replace_pages_viewer");this.$s.container=$(this.el);this.findSelectors();this.updateHint("choose");dc.app.uploader=new dc.ui.UploadDialog({editable:!1,insertPages:!0,autostart:!0,documentId:this.viewer.api.getModelId()});dc.app.uploader.setupUpload();this.handleEvents();this.delegateEvents()},unbindEvents:function(){var a=
this.$s.thumbnailImages;this.$s.thumbnails.unbind("mouseout.dv-replace").unbind("mousemove.dv-replace").unbind("mousedown.dv-replace").unbind("mouseover.dv-replace").unbind("mouseenter.dv-replace").unbind("mouseleave.dv-replace");a.unbind("mouseout.dv-replace").unbind("mouseover.dv-replace")},handleEvents:function(){var a=this.$s.thumbnails,b=this.$s.thumbnailImages;this.unbindEvents();a.each(function(a){$(this).attr("data-pageNumber",a+1)});a.bind("mouseover.dv-replace",function(){$(this).addClass("DV-hover-thumbnail")});
a.bind("mouseout.dv-replace",function(){$(".DV-overlay",this).removeClass("left").removeClass("right");$(this).removeClass("DV-hover-thumbnail")});a.bind("mousemove.dv-replace",function(a){var b=$(this);if(!b.hasClass("DV-hover-image")){b.attr("data-pageNumber");var e=b.offset(),f=b.outerWidth(!0);a=(a.clientX-e.left)/f;a=.2>a?"left":.8<a?"right":"";$(".DV-overlay",b).removeClass("left").removeClass("right").addClass(a)}});a.bind("mousedown.dv-replace",_.bind(function(a){a.preventDefault();a.stopPropagation();
this.confirmPageChoice($(a.currentTarget))},this));b.bind("mouseover.dv-replace",function(a){$(this).closest(".DV-thumbnail").addClass("DV-hover-image")});b.bind("mouseout.dv-replace",function(a){$(this).closest(".DV-thumbnail").removeClass("DV-hover-image")})},confirmPageChoice:function(a){var b=this.$s.thumbnails,c=!0;this.resetSelected();if(dc.app.hotkeys.shift&&this.$firstPageSelection&&this.$firstPageSelection.length){var c=parseInt(this.$firstPageSelection.attr("data-pageNumber"),10),d=parseInt(a.attr("data-pageNumber"),
10),e=Math.max(d,c),f=Math.min(d,c),d=c>d,g=$(".DV-overlay",a).hasClass("left"),k=$(".DV-overlay",a).hasClass("right"),c=!1;a.hasClass("DV-hover-image")||(g&&d?e-=1:g&&!d?e-=1:k&&d&&(f+=1,e-=1));g||k||!d||(e-=1);d&&!this.isFirstPageBetween&&(e+=1);e<f&&(c=!0);c||(b=b.filter(function(){var a=$(this).attr("data-pageNumber");return f<=a&&a<=e}),b.addClass("DV-selected"),this.updateHint("replace"))}if(c)if(a.hasClass("DV-hover-image"))this.$firstPageSelection=a,this.isFirstPageBetween=!1,a.addClass("DV-selected"),
this.updateHint("replace");else if(a.hasClass("DV-hover-thumbnail")){c=$(".left",b);b=$(".right",b);if(c.length)c.addClass("left_chosen"),this.$firstPageSelection=a;else if(b.length)b.addClass("right_chosen"),this.$firstPageSelection=a.next(),this.$firstPageSelection.length||(this.$firstPageSelection=a);else return this.updateHint("choose"),!1;this.isFirstPageBetween=!0;this.updateHint("insert")}},updateHint:function(a){var b,c,d;if("choose"==a)b=_.t("choose_location_to_insert_pages"),$(this.el).setMode("off",
"upload"),this.$(".replace_pages_upload_button").setMode("not","enabled");else{var e="replace"==a;$(this.el).setMode("on","upload");this.$(".replace_pages_upload_button").setMode("is","enabled");e?(c=this.getPageRange(),b=c.start!=c.end?_.t("replace_multiple_pages",c.start,c.end):_.t("replace_page_x",c.start)):"insert"==a&&(a=this.viewer.api.numberOfPages(),d=this.getInsertPageNumber(),1>d?b=_.t("insert_first_page"):d<a?b=_.t("insert_between_pages",d,d+1):d>=a&&(b=_.t("insert_last_page")));dc.app.uploader.insertPagesAttrs({insertPageAt:d,
replacePagesStart:c&&c.start,replacePagesEnd:c&&c.end})}this.$s.hint.text(b)},getPageRange:function(){var a=this.$s.thumbnails.filter(".DV-selected"),b=_.map(a,function(a){return parseInt($(a).attr("data-pageNumber"),10)}),a=_.min(b),b=_.max(b);return{start:a,end:b}},getInsertPageNumber:function(){var a=this.$s.thumbnails.has(".left,.right"),b=parseInt(a.attr("data-pageNumber"),10);if(a.find(".left").length)return b-1;if(a.find(".right").length)return b},close:function(){"is"==this.modes.open&&($(".DV-currentPageImage-disabled",
this.$s.pages).addClass("DV-currentPageImage").removeClass("DV-currentPageImage-disabled"),$(".left_chosen").removeClass("left_chosen"),$(".right_chosen").removeClass("right_chosen"),$(".DV-selected").removeClass("DV-selected"),this.setMode("not","open"),this.$s.guide.hide(),this.unbindEvents(),this.$s.guideButton.removeClass("open"),this.$s.pages.removeClass("replace_pages_viewer"),$(this.el).hide(),this.viewer.api.leaveReplacePagesMode())}});
dc.ui.SectionEditor=Backbone.View.extend({constructor:function(a){Backbone.View.call(this,a);_.bindAll(this,"addRow","saveSections","removeAllSections")},open:function(){if(this.dialog)return!1;this.sections=_.sortBy(currentDocument.api.getSections(),function(a){return parseInt(a.pageNumber,10)});this.dialog=(new dc.ui.Dialog({title:_.t("edit_sections"),information:_.t("enter_title_and_page"),id:"section_editor",mode:"confirm",saveText:_.t("save"),onClose:_.bind(function(){this.dialog=null},this),
onConfirm:_.bind(function(){return this.saveSections(this.serializeSections())},this)})).render();this.sectionsEl=$(this.make("ul",{id:"section_rows","class":"not_draggable"}));this.removeEl=$(this.make("div",{"class":"minibutton warn remove_all"},_.t("remove_all")));this.removeEl.bind("click",this.removeAllSections);this.dialog.append(this.sectionsEl);this.dialog.addControl(this.removeEl);this.renderSections()},saveSections:function(a){var b=_.pluck(a,"page_number");if(b.length>_.uniq(b).length)return this.dialog.error(_.t("no_duplicate_section"));
if(this.impossibleSections(a))return this.dialog.error(_.t("no_section_outside_doc"));$.ajax({url:"/sections/set",type:"POST",data:{sections:JSON.stringify(a),document_id:dc.app.editor.docId},dataType:"json"});this.updateNavigation(a);return!0},removeAllSections:function(){this.saveSections([]);this.dialog.close()},impossibleSections:function(a){var b=currentDocument.api.numberOfPages();return _.any(a,function(a){return 1>a.page_number||a.page_number>b})},serializeSections:function(){var a=[];$(".section_row").each(function(b,
c){var d=$("input",c).val(),e=parseInt($(".page_number",c).val(),10);d&&a.push({title:d,page_number:e,page:e})});return a},renderSections:function(){var a=this;if(!_.size(this.sections))return _.each(_.range(3),function(){a.addRow()});_.each(this.sections,function(b){a.addRow({title:b.title,page_number:b.page})})},updateNavigation:function(a){a=_.map(a,function(a){return _.extend({page:a.page_number},a)});currentDocument.api.setSections(a)},addRow:function(a){a=_.extend({pageCount:currentDocument.api.numberOfPages(),
title:"",page_number:""},a);var b=$(JST.section_row(a));$(".section_title",b).val(a.title).placeholder();$(".minus",b).bind("click",function(){b.remove()});$(".plus",b).bind("click",_.bind(function(){this.addRow({after:b})},this));if(a.after)return a.after.after(b);this.sectionsEl.append(b)}});
(function(){window.JST=window.JST||{};window.JST.control_panel=_.template('<% if (docAccess != dc.access.PUBLIC) { %>\n<div class="access_info">\n  <span>\n    <%= docAccess == dc.access.ORGANIZATION ? _.t(\'private_to\', orgName ) : _.t(\'private_access\') %>\n  </span>\n</div>\n<% } %>\n\n<div class="control_panel_title gradient_light">\n  <span class=""><%= _.t(\'document_tools\') %></span>\n</div>\n<% if (isOwner || isReviewer) { %>\n  <div class="public_annotation button">\n    <div class="icon mini_note"></div>\n    <div class="icon cancel_search"></div>\n    <span><%= _.t(\'add_public_note\') %></span>\n  </div>\n  <div id="public_note_guide" class="note_guide" style="display:none;">\n    <%= _.t(\'add_note_instructions\') %>\n    <br /><br />\n    <span class="warn"><%= _.t(\'add_public_note_warn\') %></span>\n  </div>\n<% } %>\n<div class="private_annotation button">\n  <div class="icon mini_note_private"></div>\n  <div class="icon cancel_search"></div>\n  <span><%= _.t(\'add_private_note\') %></span>\n</div>\n<div id="private_note_guide" class="note_guide" style="display:none;">\n  <%= _.t(\'add_note_instructions\') %>\n  <br /><br />\n  <span class="warn"><%= _.t(\'add_private_note_warn\') %></span>\n</div>\n<% if (isOwner || isReviewer) { %>\n  <div class="redact_annotation button">\n    <div class="icon mini_redaction"></div>\n    <div class="icon cancel_search"></div>\n    <span><%= _.t(\'redact_document\') %></span>\n  </div>\n  <div id="redact_note_guide" class="note_guide" style="display:none;">\n  <% red = _.t(\'red\'); black = _.t(\'black\') %>\n  <%= _.t(\'redact_instructions\', \'<span class="when_black">\' + black + \'</span><span class="when_red">\' + red + \'</span>\' ) %>\n    <br /><br />\n    <%= _.t(\'notes_hidden_while_redacting\') %>\n    <br /><br />\n    <div class="minibutton cancel_redactions"><%= _.t(\'cancel\') %></div>\n    <div class="minibutton default save_redactions"><%= _.t(\'save_redactions\') %></div>\n  </div> \n<% } %> \n<% if (isOwner) { %>\n  <div class="set_sections button"><span><%= _.t(\'edit_sections\') %></span></div>\n  <div class="document_fields_container">\n    <div class="edit_document_info button">\n      <div class="icon toggle toggle_document_info"></div>\n      <span><%= _.t(\'edit_document_info\') %></span>\n    </div>\n    <div class="edit_document_fields">\n      <div class="edit_title button"><span class="dash">\u2013</span>&nbsp; <span><%= _.t(\'edit_title\') %></span></div>\n      <div class="edit_source button"><span class="dash">\u2013</span>&nbsp; <span><%= _.t(\'edit_source\') %></span></div>\n      <div class="edit_description button"><span class="dash">\u2013</span>&nbsp; <span><%= _.t(\'edit_description\') %></span></div>\n      <div class="edit_access button"><span class="dash">\u2013</span>&nbsp; <span><%= _.t(\'edit_access\') %></span></div>\n      <div class="edit_related_article button"><span class="dash">\u2013</span>&nbsp; <span><%= _.t(\'edit_related_url\') %></span></div>\n      <div class="edit_document_url button"><span class="dash">\u2013</span>&nbsp; <span><%= _.t(\'edit_published_url\') %></span></div>\n    </div>\n  </div>\n  \n  <div class="edit_data button"><span><%= _.t(\'edit_document_data\') %></span></div>\n  \n  <div class="control_panel_title gradient_light">\n    <span class=""><%= _.t(\'embed_tools\') %></span>\n  </div>\n  <div class="embed_document button">\n    <span><%= _.t(\'embed_document\') %></span>\n  </div>\n  <div class="embed_note button">\n    <span><%= _.t(\'embed_note\')%></span>\n  </div>\n  \n  <div class="control_panel_title gradient_light">\n    <span class=""><%= _.t(\'page_tools\') %></span>\n  </div>\n  <div class="edit_replace_pages button">\n    <div class="icon cancel_search"></div>\n    <span><%= _.t(\'insert_replace_pages\') %></span>\n  </div>\n  <div id="edit_replace_pages_guide" class="note_guide" style="display:none;">\n    <%= _.t(\'insert_pages_instructions\') %>\n    <br /><br />\n    <%= _.t(\'insert_pages_shift_key\') %>\n  </div>\n  <div class="edit_remove_pages button">\n    <div class="icon cancel_search"></div>\n    <span><%= _.t(\'remove_pages\') %></span>\n  </div>\n  <div id="edit_remove_pages_guide" class="note_guide" style="display:none;">\n    <%= _.t(\'remove_pages_click\') %>\n    <br /><br />\n    <%= _.t(\'remove_pages_done\') %>\n  </div>\n  <div class="edit_reorder_pages button">\n    <div class="icon cancel_search"></div>\n    <span><%= _.t(\'reorder_pages\') %></span>\n  </div>\n  <div id="edit_reorder_pages_guide" class="note_guide" style="display:none;">\n    <%= _.t(\'reorder_pages_instructions\') %>\n    <br /><br />\n    <%= _.t(\'reorder_pages_done\') %>\n  </div>\n  \n  <div class="control_panel_title gradient_light">\n    <span class=""><%= _.t(\'text_tools\') %></span>\n  </div>\n  <div class="edit_page_text button">\n    <div class="icon cancel_search"></div>\n    <span><%= _.t(\'edit_page_text\') %></span>\n  </div>\n  <div id="edit_page_text_guide" class="note_guide" style="display:none;">\n    <%= _.t(\'edit_page_text_instructions\') %>\n    <br /><br />\n    <%= _.t(\'edit_page_text_done\') %>\n  </div>\n  <div class="reprocess_text button">\n    <span><%= _.t(\'reprocess_text\') %></span>\n  </div>\n<% } %>\n\n<div class="control_panel_help">\n   <% \n     help         = \'<a href="/\' + workspacePrefix + \'help" target="_blank">\' +      _.t(\'help_pages\') + \'</a>\';\n     annotation   = \'<a href="/\'+ workspacePrefix + \'help/notes" target="_blank">\' + _.t(\'annotation\') + \'</a>\';\n     modification = \'<a href="/\' + workspacePrefix + \'help/modification" target="_blank">\' + _.t(\'modification\') + \'</a>\';\n   %>\n  <%= _.t(\'tools_help\', help, annotation,  modification ) %>\n</div>\n');window.JST.document_page_tile=
_.template('<div class="document_page_tile">\n  <img src="<%= url %>" />\n  <div class="document_page_line">\n    <div class="document_page_tile_remove cancel_search icon"></div>\n    <div class="document_page_tile_number">p. <%= pageNumber %></div>\n  </div>\n</div>');window.JST.edit_page_text=_.template('<div class="edit_page_text">\n\n  <div class="editor_toolbar_controls edit_page_text_holder">\n    <div class="minibutton edit_page_text_confirm_input default not_enabled"><%= _.t(\'save_text\') %></div>\n    <div class="minibutton close_editor"><%= _.t(\'cancel\') %></div>\n  </div>\n  \n  <div class="document_page_tiles"></div>\n  \n  <div class="editor_hint edit_page_text_confirm_info"><%= _.t(\'edit_text_any_page\') %><br /><%= _.t(\'change_page_arrows\') %></div>\n  \n</div>\n\n');
window.JST.remove_pages=_.template('<div class="remove_pages">\n  \n  <div class="editor_toolbar_controls remove_pages_holder">\n    <div class="minibutton remove_pages_confirm_input default not_enabled"></div>\n    <div class="minibutton close_editor"><%= _.t(\'cancel\') %></div>\n  </div>\n  \n  <div class="remove_pages_page_container"></div>\n  \n  <div class="editor_hint"><%= _.t(\'select_pages_remove\') %></div>\n  \n</div>');window.JST.reorder_pages=_.template('<div class="reorder_pages">\n  \n  <div class="editor_toolbar_controls reorder_pages_holder">\n    <div class="minibutton not_enabled reorder_pages_confirm_input default"><%= _.t(\'save_page_order\') %></div>\n    <div class="minibutton close_editor"><%= _.t(\'cancel\') %></div>\n  </div>\n\n  <div class="editor_hint"><%= _.t(\'reorder_hint\') %></div>\n  \n</div>');
window.JST.replace_pages=_.template('<div class="replace_pages">\n  \n  <div class="editor_toolbar_controls replace_pages_holder">\n    <form id="new_document_form" action="/import/upload_document" method="POST" enctype="multipart/form-data" target="upload_iframe">\n      <div class="minibutton plus replace_pages_upload_button default" id="new_document"><div class="icon white_plus"></div><div class="center"><%= _.t(\'upload_pages\') %></div></div>\n      <button type="submit"><%= _.t(\'upload_pages\') %></button>\n      <input id="new_document_input" name="file" type="file" multiple />\n      <iframe id="upload_iframe" name="upload_iframe" src="about:blank" class="hidden_iframe"></iframe>\n    </form>\n    <div class="minibutton close_editor"><%= _.t(\'cancel\') %></div>\n  </div>\n  \n  <div class="editor_hint"></div>\n  \n</div>');
window.JST.reviewer_welcome=_.template("<%= _.t('annotation_help',fullName ) %>\n <br><br>\n<%= _.t('contact_reviewer',fullName, '<a href=\"mailto:'+ email +'\" class=\"text_link\">'+ email +'</a>',' <a href=\"https://sourceafrica.net\" class=\"text_link\">https://sourceafrica.net</a>' ) %>\n");window.JST.section_row=_.template('<li class="section_row">\n\n    <div class="text_input dark small">\n      <input class="section_title" type="text" placeholder="<%= _.t(\'title\') %>&hellip;" value="" />\n    </div>\n    <div class="text_input dark small">\n      <span class="page_number_mark"><%=_.t(\'pg\') %></span>\n      <input class="page_number" type="text" value="<%= page_number %>" />\n    </div>\n    <div class="icon minus"></div>\n    <div class="icon plus"></div>\n    <br class="clear" />\n\n</li>')})();
